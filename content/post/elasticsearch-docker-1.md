---
title: "Elasticsearch8をDockerで使ってみる (1) シングルノード構成" # Title of the blog post.
date: 2022-11-14T23:15:28+09:00 # Date of post creation.
toc: true # Controls if a table of contents should be generated for first-level links automatically.
featureImage: '/images/elasticsearch-docker.png'
thumbnail: '/images/elasticsearch-docker.png'
categories:
  - 技術記事
tags:
  - Elasticsearch
  - Docker 
---

Elasticsearchクラスタ構築の第一歩として、Docker上でElasticsearchと戯れてみる。

参考: [Install Elasticsearch with Docker | Elasticsearch Guide](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html)


# シングルノード構成

## イメージの準備

イメージは`elasticsearch`または`docker.elastic.co/elasticsearch/elasticsearch`を用いる。(どちらも内容は一緒)

今回は以下のような`Dockerfile`を作成し用いる。

```docker
FROM docker.elastic.co/elasticsearch/elasticsearch:8.5.0
RUN elasticsearch-plugin install analysis-kuromoji
```

`elasticsearch-plugin install`はElasticsearchのプラグインをインストールするコマンドである。
Elasticsearchではプラグインのインストールがほぼほぼ必須なので、
このように自前のDockerfileを作成して利用することが多いようである。

ちなみに、`analysis-kuromoji`は日本語の解析を行うためのプラグインで、
日本語データを扱う場合はほぼ必須となる。

## docker-composeの作成

先程のDockerfileと同じディレクトリに`docker-compose.yml`を作成し、以下の内容とする。

```yml
services:
  es:
    build:
      context: .
    environment:
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - 9200:9200
```

`ES_JAVA_OPTS=-Xms512m -Xmx512m`はヒープサイズの指定である。(XmsとXmxの両方に同じサイズを記述すれば良い)  
感覚的にはここで指定したメモリ+500MBくらいが必要になる気がする。

## コンテナの起動

以下のコマンドを実行してコンテナを立ち上げる。

```sh
docker-compose up -d
```

しばらくしてから正常に立ち上がっていることを確認する。

```sh
docker-compose ps
```

うまく行けばコンテナがrunningのまま動き続けているはずである。

{{% notice note "Note" %}}
ちなみに、Linuxで動かすと以下のようなエラーが出て立ち上がらない場合がある。
```
bootstrap check failure [1] of [1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
ERROR: Elasticsearch did not exit normally - check the logs at /usr/share/elasticsearch/logs/docker-cluster.log
...
ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.
```
この場合、ホスト側で`sysctl vm.max_map_count=262144`などを実行してカーネルパラメータを修正する。
{{% /notice %}}

## エンドポイントへの接続

Elasticsearch8.0以降はデフォルトでセキュリティ機能が有効になっているため、
単純にHTTPリクエストを送っただけではアクセスすることが出来ない。
本来このセキュリティ機能を使うにあたって事前にアカウントの作成やCA証明書の発行などを行う必要があるのだが、
公式イメージをシングルノード構成で使う場合はこれらが自動的にセットアップされるようになっている。

### パスワードの生成

デフォルトアカウントの`elastic`ユーザーにパスワードを設定する。

```
$ docker-compose exec es /usr/share/elasticsearch/bin/elasticsearch-reset-password
WARNING: Owner of file [/usr/share/elasticsearch/config/users] used to be [root], but now is [elasticsearch]
WARNING: Owner of file [/usr/share/elasticsearch/config/users_roles] used to be [root], but now is [elasticsearch]
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: GsSBO_UdsAk3d=dyvm=H
```

`New value:`の右にランダム生成されたパスワードが表示されるので、記録しておく。

{{% notice info "Info" %}}
(11/17追記)
今回はコマンドによりパスワードを設定したが、コンテナの環境変数`ELASTIC_PASSWORD`に設定することでもパスワードを変更可能である。

```yml:docker-compose.yml
    environment:
      - "ELASTIC_PASSWORD=p@ssw0rd"
```
{{% /notice %}}

### CA証明書のコピー

ElasticsearchはTLSを用いるために自己署名証明書を生成して用いている。
curl等でリクエストを送る際には元となったCA証明書が必要となるため、コピーしておく。

```
docker-compose cp es:/usr/share/elasticsearch/config/certs/http_ca.crt .
```

### リクエストを送ってみる

先程準備したパスワードとCA証明書を使ってリクエストを送ってみる。

```
$ curl --cacert http_ca.crt -u elastic https://localhost:9200
Enter host password for user 'elastic':
{
  "name" : "d14b64ba748f",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "Efw7ehlyRqqnG8fYRLjbmQ",
  "version" : {
    "number" : "8.5.0",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "c94b4700cda13820dad5aa74fae6db185ca5c304",
    "build_date" : "2022-10-24T16:54:16.433628434Z",
    "build_snapshot" : false,
    "lucene_version" : "9.4.1",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
```

# 次回

今回は、公式イメージの自動セットアップ機能を活用しつつ最低限のノードを立ち上げてみた。

次回はデータの永続化に関する設定と、それに伴って必要となる自前でのセキュリティ基盤の構築を行う。

[Elasticsearch8をDockerで使ってみる (2) | 永続化とX-Packセキュリティ](/post/elasticsearch-docker-2/)
